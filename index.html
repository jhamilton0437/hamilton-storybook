<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hamilton Story Time üìö‚ú®</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: white;
            overflow-x: hidden;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .section {
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .section h2 {
            margin-top: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .heroes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        @media (min-width: 500px) {
            .heroes { grid-template-columns: repeat(3, 1fr); }
        }
        .hero {
            background: rgba(255,255,255,0.2);
            border: 3px solid transparent;
            border-radius: 16px;
            padding: 20px 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .hero:hover { background: rgba(255,255,255,0.3); }
        .hero.selected {
            background: rgba(255,255,255,0.9);
            color: #764ba2;
            border-color: white;
        }
        .hero .emoji { font-size: 2em; margin-bottom: 8px; }
        .hero .name { font-weight: 600; }
        .hero .age { font-size: 0.85em; opacity: 0.8; }
        
        .options { display: flex; flex-wrap: wrap; gap: 12px; }
        .option {
            background: rgba(255,255,255,0.2);
            border: 3px solid transparent;
            border-radius: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1em;
            min-width: 100px;
            text-align: center;
        }
        .option:hover { background: rgba(255,255,255,0.3); }
        .option.selected {
            background: rgba(255,255,255,0.9);
            color: #764ba2;
            border-color: white;
        }
        
        .mode-toggle { display: flex; gap: 12px; flex-wrap: wrap; }
        .mode-btn {
            flex: 1;
            min-width: 120px;
            padding: 16px;
            background: rgba(255,255,255,0.2);
            border: 3px solid transparent;
            border-radius: 12px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn:hover { background: rgba(255,255,255,0.3); }
        .mode-btn.active {
            background: rgba(255,255,255,0.9);
            color: #764ba2;
            border-color: white;
        }
        
        .generate {
            width: 100%;
            padding: 24px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 1.4em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.4);
        }
        .generate:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(240, 147, 251, 0.5); }
        .generate:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .tip {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 12px;
            font-style: italic;
        }
        
        .api-section {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .api-section input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            margin-top: 8px;
        }
        .api-section small { opacity: 0.8; }

        /* Picture Book Overlay */
        .picture-book {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            z-index: 1000;
            flex-direction: column;
        }
        .picture-book.visible { display: flex; }
        
        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0,0,0,0.3);
        }
        .book-title {
            font-size: 1.3em;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }
        .close-book {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .page-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }
        .page {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            animation: pageFlip 0.4s ease;
        }
        @keyframes pageFlip {
            0% { transform: rotateY(-10deg) scale(0.95); opacity: 0.5; }
            100% { transform: rotateY(0) scale(1); opacity: 1; }
        }
        
        .page-illustration {
            width: 100%;
            aspect-ratio: 4/3;
            background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            overflow: hidden;
        }
        .page-illustration img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .page-illustration.loading {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .page-illustration.loading::after {
            content: 'üé®';
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        .page-text {
            padding: 24px;
            font-size: 1.2em;
            line-height: 1.6;
            color: #333;
            text-align: center;
            min-height: 120px;
        }
        
        .page-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0,0,0,0.3);
        }
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .page-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .page-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-dot.active { background: white; transform: scale(1.2); }
        .page-number {
            text-align: center;
            opacity: 0.7;
            font-size: 0.9em;
            margin-top: 8px;
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .loading-overlay.visible { display: flex; }
        .loading-spinner {
            font-size: 4em;
            animation: spin 2s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-text {
            margin-top: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        .loading-progress {
            margin-top: 20px;
            width: 80%;
            max-width: 300px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        .loading-bar {
            height: 100%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Hamilton Story Time ‚ú®</h1>
        <p class="subtitle">Magical illustrated stories for our family!</p>

        <div class="api-section" id="apiSection" style="display: none;">
            <small>üîë OpenAI API Key:</small>
            <input type="password" id="apiKey" placeholder="sk-...">
            <button onclick="saveAndHideKey()" style="margin-top:8px;padding:8px 16px;border:none;border-radius:8px;background:white;cursor:pointer;">Save</button>
        </div>
        <div style="text-align:right;margin-bottom:10px;">
            <button onclick="toggleApiSection()" style="background:none;border:none;color:white;opacity:0.5;cursor:pointer;font-size:0.9em;">‚öôÔ∏è Settings</button>
        </div>

        <div class="section">
            <h2>üëß Who's the Hero?</h2>
            <p style="opacity: 0.8; margin-bottom: 12px; font-size: 0.9em;">Hamilton Sisters</p>
            <div class="heroes">
                <div class="hero selected" onclick="toggleHero(this)" data-hero="Evelyn">
                    <div class="emoji">üåü</div>
                    <div class="name">Evelyn</div>
                    <div class="age">Age 11</div>
                </div>
                <div class="hero" onclick="toggleHero(this)" data-hero="Lucy">
                    <div class="emoji">üåô</div>
                    <div class="name">Lucy</div>
                    <div class="age">Age 11</div>
                </div>
                <div class="hero" onclick="toggleHero(this)" data-hero="Goldie">
                    <div class="emoji">üåª</div>
                    <div class="name">Goldie</div>
                    <div class="age">Age 5</div>
                </div>
                <div class="hero" onclick="toggleHero(this)" data-hero="Rosemary">
                    <div class="emoji">üåπ</div>
                    <div class="name">Rosemary</div>
                    <div class="age">Age 5</div>
                </div>
            </div>
            <p style="opacity: 0.8; margin: 16px 0 12px; font-size: 0.9em;">Wright Sisters</p>
            <div class="heroes">
                <div class="hero" onclick="toggleHero(this)" data-hero="Livi">
                    <div class="emoji">ü¶ã</div>
                    <div class="name">Livi</div>
                    <div class="age">Age 11</div>
                </div>
                <div class="hero" onclick="toggleHero(this)" data-hero="Sutton">
                    <div class="emoji">üå∑</div>
                    <div class="name">Sutton</div>
                    <div class="age">Age 9</div>
                </div>
            </div>
            <p style="opacity: 0.8; margin: 16px 0 12px; font-size: 0.9em;">Friends</p>
            <div class="heroes">
                <div class="hero" onclick="toggleHero(this)" data-hero="Abby">
                    <div class="emoji">üåà</div>
                    <div class="name">Abby</div>
                    <div class="age">Age 8</div>
                </div>
                <div class="hero" onclick="toggleHero(this)" data-hero="Tennyson">
                    <div class="emoji">‚≠ê</div>
                    <div class="name">Tennyson</div>
                    <div class="age">Age 5</div>
                </div>
            </div>
            <p class="tip">Tap to select one or more heroes!</p>
        </div>

        <div class="section">
            <h2>üé≠ What Kind of Adventure?</h2>
            <div class="options">
                <div class="option selected" onclick="selectOption(this, 'theme')">üêâ Dragons</div>
                <div class="option" onclick="selectOption(this, 'theme')">üöÄ Space</div>
                <div class="option" onclick="selectOption(this, 'theme')">ü¶Ñ Unicorns</div>
                <div class="option" onclick="selectOption(this, 'theme')">üßú‚Äç‚ôÄÔ∏è Mermaids</div>
                <div class="option" onclick="selectOption(this, 'theme')">üëë Princess</div>
                <div class="option" onclick="selectOption(this, 'theme')">ü¶∏‚Äç‚ôÄÔ∏è Superheroes</div>
                <div class="option" onclick="selectOption(this, 'theme')">‚öΩ Soccer</div>
                <div class="option" onclick="selectOption(this, 'theme')">ü™Ñ Magic</div>
                <div class="option" onclick="selectOption(this, 'theme')">ü¶ï Dinosaurs</div>
                <div class="option" onclick="selectOption(this, 'theme')">üßö Fairies</div>
                <div class="option" onclick="selectOption(this, 'theme')">üè¥‚Äç‚ò†Ô∏è Pirates</div>
                <div class="option" onclick="selectOption(this, 'theme')">üêæ Paw Patrol</div>
                <div class="option" onclick="selectOption(this, 'theme')">üé™ Circus</div>
                <div class="option" onclick="selectOption(this, 'theme')">üïµÔ∏è Mystery</div>
                <div class="option" onclick="selectOption(this, 'theme')">üèïÔ∏è Camping</div>
                <div class="option" onclick="selectOption(this, 'theme')">üéÑ Christmas</div>
            </div>
        </div>

        <div class="section">
            <h2>üó∫Ô∏è Where Does It Happen?</h2>
            <div class="options">
                <div class="option selected" onclick="selectOption(this, 'place')">üè∞ Castle</div>
                <div class="option" onclick="selectOption(this, 'place')">üå≤ Enchanted Forest</div>
                <div class="option" onclick="selectOption(this, 'place')">üåä Underwater Kingdom</div>
                <div class="option" onclick="selectOption(this, 'place')">‚òÅÔ∏è Cloud Kingdom</div>
                <div class="option" onclick="selectOption(this, 'place')">üè† Our House</div>
                <div class="option" onclick="selectOption(this, 'place')">üåå Outer Space</div>
                <div class="option" onclick="selectOption(this, 'place')">üèùÔ∏è Tropical Island</div>
                <div class="option" onclick="selectOption(this, 'place')">üé¢ Amusement Park</div>
                <div class="option" onclick="selectOption(this, 'place')">üèîÔ∏è Mountain Top</div>
                <div class="option" onclick="selectOption(this, 'place')">üåã Volcano Land</div>
                <div class="option" onclick="selectOption(this, 'place')">üç≠ Candy World</div>
                <div class="option" onclick="selectOption(this, 'place')">ü¶ñ Dinosaur Valley</div>
                <div class="option" onclick="selectOption(this, 'place')">üèúÔ∏è Desert Oasis</div>
                <div class="option" onclick="selectOption(this, 'place')">‚ùÑÔ∏è Ice Kingdom</div>
            </div>
        </div>

        <div class="section">
            <h2>ü§™ Silly Mode?</h2>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setSilly(false)" id="sillyOff">üòä Normal</button>
                <button class="mode-btn" onclick="setSilly(true)" id="sillyOn">ü§™ SILLY!</button>
            </div>
            <p class="tip" id="sillyTip">Turn on for goofy surprises!</p>
        </div>

        <div class="section">
            <h2>üêï Include the Dogs?</h2>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setDogs(true)" id="dogsOn">üêï Yes!</button>
                <button class="mode-btn" onclick="setDogs(false)" id="dogsOff">‚ùå Not today</button>
            </div>
            <p class="tip">Bear, Buddy, and Lola join the adventure!</p>
        </div>

        <button class="generate" onclick="generateStory()" id="generateBtn">
            ‚ú® Create Our Illustrated Story! ‚ú®
        </button>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">üé®</div>
        <div class="loading-text" id="loadingText">Creating your magical story...</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
    </div>

    <!-- Picture Book Overlay -->
    <div class="picture-book" id="pictureBook">
        <div class="book-header">
            <div style="width:44px"></div>
            <div class="book-title" id="bookTitle">Story Title</div>
            <button class="close-book" onclick="closeBook()">‚úï</button>
        </div>
        <div class="page-container">
            <div class="page">
                <div class="page-illustration" id="pageIllustration"></div>
                <div class="page-text" id="pageText">Story text goes here...</div>
            </div>
        </div>
        <div class="page-nav">
            <button class="nav-btn" onclick="prevPage()" id="prevBtn">‚Üê Back</button>
            <div style="text-align: center;">
                <div class="page-dots" id="pageDots"></div>
                <div class="page-number" id="pageNumber">Page 1 of 6</div>
            </div>
            <button class="nav-btn" onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
        </div>
    </div>

    <script>
        let selections = {
            heroes: ['Evelyn'],
            theme: 'üêâ Dragons',
            place: 'üè∞ Castle',
            silly: false,
            dogs: true
        };
        
        let currentStory = null;
        let currentPage = 0;

        function toggleHero(el) {
            const hero = el.dataset.hero;
            const index = selections.heroes.indexOf(hero);
            if (index > -1) {
                if (selections.heroes.length > 1) {
                    selections.heroes.splice(index, 1);
                    el.classList.remove('selected');
                }
            } else {
                selections.heroes.push(hero);
                el.classList.add('selected');
            }
        }

        function selectOption(el, type) {
            el.parentElement.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selections[type] = el.textContent.trim();
        }

        function setSilly(isSilly) {
            selections.silly = isSilly;
            document.getElementById('sillyOff').classList.toggle('active', !isSilly);
            document.getElementById('sillyOn').classList.toggle('active', isSilly);
            document.getElementById('sillyTip').textContent = isSilly 
                ? 'üéâ Get ready for MAXIMUM silliness!' 
                : 'Turn on for goofy surprises!';
        }

        function setDogs(include) {
            selections.dogs = include;
            document.getElementById('dogsOn').classList.toggle('active', include);
            document.getElementById('dogsOff').classList.toggle('active', !include);
        }

        function showLoading(text, progress) {
            document.getElementById('loadingOverlay').classList.add('visible');
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingBar').style.width = progress + '%';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('visible');
        }

        async function generateStory() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please add your OpenAI API key first! (Ask Dad!)');
                return;
            }

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;

            try {
                showLoading('‚úçÔ∏è Writing your story...', 10);

                // Step 1: Generate story with GPT-4
                const storyData = await generateStoryText(apiKey);
                
                showLoading('üé® Creating illustrations (1/6)...', 20);

                // Step 2: Generate images for each page
                const pages = [];
                for (let i = 0; i < storyData.pages.length; i++) {
                    showLoading(`üé® Creating illustration ${i + 1}/${storyData.pages.length}...`, 20 + (i * 12));
                    
                    const imageUrl = await generateImage(apiKey, storyData.pages[i].imagePrompt);
                    pages.push({
                        text: storyData.pages[i].text,
                        imageUrl: imageUrl
                    });
                }

                showLoading('‚ú® Finishing touches...', 95);

                currentStory = {
                    title: storyData.title,
                    pages: pages
                };

                hideLoading();
                showPictureBook();

            } catch (error) {
                hideLoading();
                alert('Oops! Something went wrong: ' + error.message);
            }

            btn.disabled = false;
        }

        async function generateStoryText(apiKey) {
            const heroNames = selections.heroes.join(', ');
            const theme = selections.theme.substring(2).trim();
            const place = selections.place.substring(2).trim();
            
            const heroAges = {
                'Evelyn': '11-year-old girl with brown hair',
                'Lucy': '11-year-old girl with brown hair', 
                'Goldie': '5-year-old girl with blonde curly hair',
                'Rosemary': '5-year-old girl with reddish-brown hair',
                'Livi': '11-year-old girl with light brown hair',
                'Sutton': '9-year-old girl with blonde hair',
                'Abby': '8-year-old girl',
                'Tennyson': '5-year-old girl'
            };
            
            const heroDescriptions = selections.heroes.map(h => `${h} (${heroAges[h]})`).join(', ');
            
            let dogsText = '';
            if (selections.dogs) {
                dogsText = ' The family dogs join them: Bear (a huge fluffy white Great Pyrenees), Buddy (a happy golden retriever), and tiny Lola (an elderly dachshund).';
            }

            const sillyNote = selections.silly 
                ? 'Make it SILLY and FUNNY with absurd humor, goofy situations, and unexpected twists that will make kids laugh out loud!'
                : 'Make it magical and heartwarming.';

            const prompt = `Create a 6-page illustrated children's bedtime story.

HEROES: ${heroDescriptions}
THEME: ${theme}
SETTING: ${place}
${dogsText}

${sillyNote}

Return a JSON object with this exact structure:
{
  "title": "Story Title",
  "pages": [
    {
      "text": "The story text for this page (2-3 sentences, simple language for ages 5-11)",
      "imagePrompt": "Detailed image prompt for DALL-E: children's book illustration style, [describe the scene with characters, action, setting, mood]. The characters are realistic children, not cartoon. Warm, magical lighting. No text in image."
    }
  ]
}

IMPORTANT for imagePrompt:
- Describe the children's appearance consistently (hair color, age)
- Use "children's book illustration, warm colors, magical atmosphere" style
- Describe specific actions and emotions
- Include the setting details
- Keep characters looking realistic but storybook-like
- NEVER include text/words in the image description`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        { role: 'system', content: 'You are a children\'s book author. Return only valid JSON, no markdown.' },
                        { role: 'user', content: prompt }
                    ],
                    max_tokens: 2000,
                    temperature: 0.8
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            let content = data.choices[0].message.content;
            // Clean up markdown if present
            content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            return JSON.parse(content);
        }

        async function generateImage(apiKey, prompt) {
            const response = await fetch('https://api.openai.com/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'dall-e-3',
                    prompt: prompt,
                    n: 1,
                    size: '1024x1024',
                    quality: 'standard'
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            return data.data[0].url;
        }

        function showPictureBook() {
            currentPage = 0;
            document.getElementById('bookTitle').textContent = currentStory.title;
            
            const dotsContainer = document.getElementById('pageDots');
            dotsContainer.innerHTML = currentStory.pages.map((_, i) => 
                `<div class="page-dot ${i === 0 ? 'active' : ''}" onclick="goToPage(${i})"></div>`
            ).join('');
            
            updatePage();
            document.getElementById('pictureBook').classList.add('visible');
        }

        function updatePage() {
            const page = currentStory.pages[currentPage];
            
            const illustration = document.getElementById('pageIllustration');
            illustration.innerHTML = `<img src="${page.imageUrl}" alt="Story illustration">`;
            
            document.getElementById('pageText').textContent = page.text;
            document.getElementById('pageNumber').textContent = `Page ${currentPage + 1} of ${currentStory.pages.length}`;
            
            document.querySelectorAll('.page-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === currentPage);
            });
            
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').textContent = currentPage === currentStory.pages.length - 1 ? 'üè† Done' : 'Next ‚Üí';
            
            // Animate
            const pageEl = document.querySelector('.page');
            pageEl.style.animation = 'none';
            pageEl.offsetHeight;
            pageEl.style.animation = 'pageFlip 0.4s ease';
        }

        function nextPage() {
            if (currentPage < currentStory.pages.length - 1) {
                currentPage++;
                updatePage();
            } else {
                closeBook();
            }
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                updatePage();
            }
        }

        function goToPage(page) {
            currentPage = page;
            updatePage();
        }

        function closeBook() {
            document.getElementById('pictureBook').classList.remove('visible');
        }

        // Touch swipe
        let touchStartX = 0;
        document.getElementById('pictureBook').addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
        });
        document.getElementById('pictureBook').addEventListener('touchend', e => {
            const diff = touchStartX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) nextPage();
                else prevPage();
            }
        });

        // Load saved API key
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('storyApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            } else {
                // No key saved, show the input
                document.getElementById('apiSection').style.display = 'block';
            }
        });
        
        function toggleApiSection() {
            const section = document.getElementById('apiSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
        
        function saveAndHideKey() {
            const key = document.getElementById('apiKey').value;
            if (key) {
                localStorage.setItem('storyApiKey', key);
                document.getElementById('apiSection').style.display = 'none';
            }
        }
        
        document.getElementById('apiKey').addEventListener('change', e => {
            localStorage.setItem('storyApiKey', e.target.value);
        });
    </script>
</body>
</html>
